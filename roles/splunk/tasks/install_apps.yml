---
# This task MUST be called by configure_apps.yml to work correctly. Do NOT call this task directly via the deployment_task var!
- name: Include determine_handler.yml
  include_tasks: determine_handler.yml

- name: Check if correct vars are defined for SHC app management
  include_tasks: check_shc_app_man.yml
  when: handler == "apply shcluster-bundle"

# Note: By using the synchronize module, if the repo already exists on the target host, we are able to only update the diff while preserving the local/ folder
- name: "Synchronize {{ git_app_var.name }} repo from local Ansible host to {{ splunk_home }}/{{ app_dest }}/{{ git_app_var.name }} on remote host"
  synchronize:
    src: "{{ app_src }}"
    dest: "{{ splunk_home }}/{{ app_dest }}/"
    recursive: true
    delete: true
    checksum: true
    rsync_opts:
      - "--prune-empty-dirs"
      - "--itemize-changes"
      - "--no-owner"
      - "--no-group"
      - "--no-times"
  become: true
  become_user: "{{ splunk_nix_user }}"
  notify: "{{ handler }}"

- name: Ensure correct permissions are set
  file:
    path: "{{ splunk_home }}/{{ app_dest }}/{{ git_app_var.name }}"
    owner: "{{ splunk_nix_user }}"
    group: "{{ splunk_nix_group }}"
    recurse: true
  become: true
