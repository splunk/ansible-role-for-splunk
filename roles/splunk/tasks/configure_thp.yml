---
# Authored by Mason Morales for Splunk, Inc.
# References:
# https://blacksaildivision.com/how-to-disable-transparent-huge-pages-on-centos
# https://github.com/objectrocket/ansible-hadoop/blob/master/playbooks/roles/common/tasks/main.yml
- name: Install disable-thp service to systemd (CentOS/RHEL 7+)
  copy:
    src: disable-thp.service
    dest: /etc/systemd/system/disable-thp.service
    mode: 0644
    owner: root
    group: root
  become: true
  notify:
    - reload systemctl daemon
  # NOTE ansible_connection!="docker" is not included in the when expression
  # because we want to test this task's functionality, we want it to run even though it does nothing for a container
  # but the notified handlers above will be skipped by their when expressions
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version|int > 6
    - use_tuned_thp is not defined

- name: Configure THP using tuned profile
  copy:
    src: tuned_thp.conf
    dest: /etc/tuned/splunk/tuned.conf
    mode: 0644
    owner: root
    group: root
  become: true
  when: use_tuned_thp == true

- name: Enable tuned profile
  command: tuned-adm profile splunk
  become: true
  when: use_tuned_thp == true

- name: Disable THP service
  service:
    name: disable-thp
    enabled: yes
    state: started
  become: true
  # no (real) services in docker containers
  # and no need to bother for molecule testing
  when:
    - ansible_connection!="docker"
    - "'full' in group_names"
    - use_tuned_thp is not defined
  ignore_errors: true
